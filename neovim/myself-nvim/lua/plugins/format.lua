-- ============================================================================
-- 代码格式化插件配置
-- 使用 conform.nvim 提供统一的代码格式化接口
-- ============================================================================

-- ----------------------------------------------------------------------------
-- 调试开关
-- 如果第一行为 true，整个配置将被禁用（返回空表）
-- 删除或注释掉这行代码来激活此配置文件
-- ----------------------------------------------------------------------------
-- if true then return {} end

-- ----------------------------------------------------------------------------
-- 插件定义
-- conform.nvim 是一个轻量级的代码格式化插件
-- 支持多种格式化工具，提供统一的接口和异步格式化能力
-- ----------------------------------------------------------------------------
local CodeFormatter = {
    -- 插件仓库地址
    'stevearc/conform.nvim',
    
    -- ------------------------------------------------------------------------
    -- 延迟加载事件
    -- 只在打开或创建文件时加载此插件，优化启动速度
    -- ------------------------------------------------------------------------
    event = { 
        'BufReadPost',  -- 读取已存在的文件后触发
        'BufNewFile'    -- 创建新文件时触发
    },
    
    -- 插件选项（这里为空，实际配置在 config 函数中）
    opts = {},

    -- ------------------------------------------------------------------------
    -- 插件配置函数
    -- 在插件加载后执行，设置格式化工具和快捷键
    -- ------------------------------------------------------------------------
    config = function()
        -- 初始化 conform.nvim 插件
        require('conform').setup {
            -- ----------------------------------------------------------------
            -- 按文件类型配置格式化工具
            -- 每种文件类型可以指定一个或多个格式化工具（按顺序执行）
            -- ----------------------------------------------------------------
            formatters_by_ft = {
                -- Lua 文件使用 stylua 格式化
                -- stylua 是专门为 Lua 设计的格式化工具
                lua = { 'stylua' },
                
                -- C/C++ 文件使用 clang-format（已注释）
                -- clang-format 是 LLVM 项目的代码格式化工具
                -- cpp = { 'clang-format' },
                -- c = { 'clang-format' },
                
                -- JSON 和 JSONC（带注释的 JSON）使用 prettier
                json = { 'prettier' },
                jsonc = { 'prettier' },
                
                -- Web 前端文件使用 prettier
                -- prettier 是前端生态中最流行的格式化工具
                html = { 'prettier' },
                css = { 'prettier' },
                
                -- Astro 框架文件使用 prettier
                astro = { 'prettier' },
                
                -- JavaScript 和 TypeScript 使用 prettier
                typescript = { 'prettier' },
                javascript = { 'prettier' },
            },
        }

        -- --------------------------------------------------------------------
        -- 格式化函数
        -- 封装 conform.format 调用，统一处理格式化逻辑
        -- --------------------------------------------------------------------
        local do_format = function()
            require('conform').format { 
                async = true,        -- 异步执行，不阻塞编辑器
                lsp_fallback = true  -- 如果没有外部格式化工具，回退到 LSP 格式化
            }
        end

        -- --------------------------------------------------------------------
        -- 键位映射
        -- 在普通模式下，使用 <leader>lf 触发格式化
        -- --------------------------------------------------------------------
        vim.keymap.set(
            'n',                -- 普通模式
            '<leader>lf',       -- 快捷键：Leader + l + f (LSP Format)
            do_format,          -- 执行格式化函数
            { 
                desc = 'Format Current Buffer',  -- 描述（在 which-key 中显示）
                noremap = true,                  -- 非递归映射
                silent = true                    -- 静默执行
            }
        )

        -- --------------------------------------------------------------------
        -- 用户命令
        -- 创建 :Format 命令，可在命令行模式下执行格式化
        -- --------------------------------------------------------------------
        vim.api.nvim_create_user_command(
            'Format',           -- 命令名称
            do_format,          -- 执行的函数
            { 
                desc = 'Format Current Buffer'  -- 命令描述
            }
        )
    end,
}

-- 返回插件配置表，供 Lazy.nvim 加载
return CodeFormatter