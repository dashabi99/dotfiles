-- ============================================================================
-- 代码补全插件配置
-- 使用 blink.cmp 提供快速、智能的代码补全界面
-- blink.cmp 是一个用 Rust 编写的高性能补全引擎
-- ============================================================================

-- ----------------------------------------------------------------------------
-- 调试开关
-- 如果第一行为 true，整个配置将被禁用（返回空表)
-- 删除或注释掉这行代码来激活此配置文件
-- ----------------------------------------------------------------------------
-- if true then return {} end -- 警告：删除此行以激活此文件

-- ----------------------------------------------------------------------------
-- 插件定义
-- blink.cmp 是一个现代化的补全插件，性能优异
-- ----------------------------------------------------------------------------
local CodeCompletion = {
    -- 插件仓库地址
    'saghen/blink.cmp',
    
    -- ------------------------------------------------------------------------
    -- 依赖插件
    -- 可选：为代码片段源提供代码片段支持
    -- ------------------------------------------------------------------------
    dependencies = {
        'catppuccin/nvim',  -- Catppuccin 主题（提供配色支持）
    },

    -- ------------------------------------------------------------------------
    -- 延迟加载事件
    -- 只在打开或创建文件时加载此插件
    -- ------------------------------------------------------------------------
    event = { 
        'BufReadPost',  -- 读取已存在的文件后触发
        'BufNewFile'    -- 创建新文件时触发
    },

    -- ------------------------------------------------------------------------
    -- 版本控制
    -- 使用发布标签下载预构建的二进制文件
    -- ------------------------------------------------------------------------
    version = '1.*',  -- 使用 1.x 系列的最新版本
    
    -- 或者从源代码构建（需要 Rust nightly）
    -- 参考：https://rust-lang.github.io/rustup/concepts/channels.html#working-with-nightly-rust
    -- build = 'cargo build --release',
    
    -- 如果使用 Nix，可以使用最新的 nightly Rust 从源代码构建：
    -- build = 'nix run .#build-plugin',

    -- ------------------------------------------------------------------------
    -- 插件选项配置
    -- 类型注解用于编辑器的代码补全和类型检查
    -- ------------------------------------------------------------------------
    ---@module 'blink.cmp'
    ---@diagnostic disable:undefined-doc-name
    ---@type blink.cmp.Config
    opts = {
        -- ====================================================================
        -- 键位映射配置
        -- ====================================================================
        -- 
        -- 预设选项：
        -- 'default' (推荐) - 类似内置补全的映射（C-y 接受补全）
        -- 'super-tab'      - 类似 VSCode 的映射（Tab 接受补全）
        -- 'enter'          - 回车接受补全
        -- 'none'           - 无预设映射
        --
        -- 所有预设都包含以下基础映射：
        -- C-space：打开菜单，或在已打开时打开文档
        -- C-n/C-p 或 上/下方向键：选择下一个/上一个项
        -- C-e：隐藏菜单
        -- C-k：切换函数签名帮助（如果 signature.enabled = true）
        --
        -- 参考 :h blink-cmp-config-keymap 自定义键位映射
        keymap = {
            preset = 'default',  -- 使用默认预设
            
            -- 显示/隐藏文档
            ['<C-k>'] = { 
                'show',                -- 显示补全菜单
                'show_documentation',  -- 显示文档
                'hide_documentation'   -- 隐藏文档
            },
            
            -- 隐藏补全菜单
            ['<C-e>'] = { 'hide' },
            
            -- 方向键导航
            ['<Up>'] = { 
                'select_prev',  -- 选择上一项
                'fallback'      -- 如果菜单未打开，使用默认行为
            },
            ['<Down>'] = { 
                'select_next',  -- 选择下一项
                'fallback' 
            },
            
            -- 代码片段导航
            ['<C-p>'] = { 
                'snippet_backward',       -- 跳转到代码片段的上一个占位符
                'fallback_to_mappings'    -- 如果不在代码片段中，回退到其他映射
            },
            ['<C-n>'] = { 
                'snippet_forward',        -- 跳转到代码片段的下一个占位符
                'fallback_to_mappings' 
            },
            
            -- Tab 键导航
            ['<Tab>'] = { 
                'select_next',  -- 选择下一项
                'fallback' 
            },
            ['<S-Tab>'] = {     -- Shift+Tab
                'select_prev',  -- 选择上一项
                'fallback_to_mappings' 
            },
            
            -- 文档滚动
            ['<C-b>'] = { 
                'scroll_documentation_up',  -- 向上滚动文档
                'fallback' 
            },
            ['<C-f>'] = { 
                'scroll_documentation_down',  -- 向下滚动文档
                'fallback' 
            },
            
            -- 接受补全
            ['<CR>'] = {      -- 回车键
                'accept',     -- 接受当前选中的补全项
                'fallback'    -- 如果没有选中项，执行默认的回车行为
            },
        },

        -- ====================================================================
        -- 外观配置
        -- ====================================================================
        appearance = {
            -- Nerd Font 变体设置
            -- 'mono'（默认）- 使用 'Nerd Font Mono'
            -- 'normal'       - 使用 'Nerd Font'
            -- 调整间距以确保图标对齐
            nerd_font_variant = 'normal',
        },

        -- ====================================================================
        -- 补全行为配置
        -- ====================================================================
        completion = {
            -- 补全菜单设置
            menu = {
                border = 'rounded',  -- 圆角边框
            },
            
            -- 文档窗口配置
            -- （默认）仅在手动触发时显示文档弹窗
            documentation = {
                auto_show = true,    -- 自动显示文档（选中补全项时）
                window = {
                    border = 'rounded',  -- 圆角边框
                },
            },
            
            -- 补全列表配置
            list = {
                selection = {
                    preselect = false,    -- 不自动预选第一项
                    auto_insert = true,   -- 选中后自动插入（不需要额外确认）
                },
            },
        },

        -- ====================================================================
        -- 补全来源配置
        -- ====================================================================
        -- 定义默认启用的补全提供者列表
        -- 可以在配置的其他地方扩展此列表，而无需重新定义
        -- 这要归功于 `opts_extend` 配置
        sources = {
            -- 默认启用的补全源（按优先级排序）
            default = { 
                'snippets',  -- 代码片段
                'lsp',       -- 语言服务器协议（LSP）
                'path',      -- 文件路径
                'buffer'     -- 当前缓冲区的文本
            },
            
            -- 补全提供者的详细配置
            providers = {
                -- 代码片段提供者配置
                snippets = {
                    opts = {
                        -- 禁用 friendly-snippets（内置代码片段集合）
                        -- 如果你想使用自己的代码片段，可以设置为 false
                        friendly_snippets = false,

                        -- 扩展的文件类型映射
                        -- 为特定文件类型添加额外的代码片段支持
                        --
                        -- 可用框架列表参考：
                        -- https://github.com/rafamadriz/friendly-snippets/tree/main/snippets/frameworks
                        --
                        -- 可用语言搜索参考：
                        -- https://github.com/rafamadriz/friendly-snippets/blob/main/package.json
                        --
                        -- 以下仅为示例，应只启用你实际使用的框架
                        extended_filetypes = {
                            astro = { 'html' },           -- Astro 文件使用 HTML 片段
                            markdown = { 'blog', 'html' },-- Markdown 使用博客和 HTML 片段
                            zsh = { 'sh' },               -- Zsh 使用 Shell 片段
                            python = { 'django', 'flask' }, -- Python 使用 Django 和 Flask 片段
                            lua = { 'lua', 'neovim' },      -- Lua 使用 Neovim 片段
                        },
                    },
                },
            },
        },

        -- ====================================================================
        -- 模糊匹配配置
        -- ====================================================================
        -- （默认）使用 Rust 实现的模糊匹配器，具有容错性和显著更好的性能
        -- 
        -- 可选实现：
        -- 'rust'                  - 仅使用 Rust 实现
        -- 'lua'                   - 使用 Lua 实现
        -- 'prefer_rust'           - 优先 Rust，不可用时回退到 Lua
        -- 'prefer_rust_with_warning' - 优先 Rust，不可用时警告并回退到 Lua
        --
        -- 参考模糊匹配文档获取更多信息
        fuzzy = { 
            implementation = 'prefer_rust_with_warning'  -- 推荐：Rust 优先，带警告
        },
    },
    
    -- ------------------------------------------------------------------------
    -- 扩展选项
    -- 允许在其他地方扩展 sources.default 列表而不覆盖
    -- ------------------------------------------------------------------------
    opts_extend = { 'sources.default' },
}

return CodeCompletion